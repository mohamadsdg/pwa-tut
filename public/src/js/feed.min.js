var picture,shareImageButton=document.querySelector("#share-image-button"),createPostArea=document.querySelector("#create-post"),closeCreatePostModalButton=document.querySelector("#close-create-post-modal-btn"),sharedMomentsArea=document.querySelector("#shared-moments"),form=document.querySelector("form"),titleInput=document.querySelector("#title"),locationInput=document.querySelector("#location"),videoPlayer=document.querySelector("#player"),canvasElement=document.querySelector("#canvas"),captureButton=document.querySelector("#capture-btn"),imagePicker=document.querySelector("#image-picker"),imagePickerArea=document.querySelector("#pick-image"),locationBtn=document.querySelector("#location-btn"),locationLoader=document.querySelector("#location-loader"),fetchedLocation={lat:0,lng:0};function initializeLocation(){void 0===navigator.geolocation&&(locationBtn.style.display="none")}function initializeMedia(){console.log("navigator->",navigator.mediaDevices),void 0===navigator.mediaDevices&&(navigator.mediaDevices={}),void 0===navigator.mediaDevices.getUserMedia&&(navigator.mediaDevices.getUserMedia=function(a){var o=navigator.webkitGetUserMedia||navigator.mozGetUserMedia;return o?new Promise(function(e,t){o.call(navigator,a,e,t)}):Promise.reject(new Error("getUserMedia is not implemented in this browser"))}),navigator.mediaDevices.getUserMedia({video:!0}).then(e=>{"srcObject"in videoPlayer?videoPlayer.srcObject=e:videoPlayer.src=window.URL.createObjectURL(e),videoPlayer.style.display="block"}).catch(function(e){imagePickerArea.style.display="block",captureButton.style.display="none",console.log(e.name+": "+e.message)})}function openCreatePostModal(){setTimeout(function(){createPostArea.style.transform="translateY(0)"},1),initializeMedia(),initializeLocation(),deferredPrompt&&(deferredPrompt.prompt(),deferredPrompt.userChoice.then(function(e){console.log(e.outcome),"dismissed"===e.outcome?console.log("User cancelled installation"):console.log("User added to home screen")}),deferredPrompt=null)}function closeCreatePostModal(){imagePickerArea.style.display="none",videoPlayer.style.display="none",canvasElement.style.display="none",locationBtn.style.display="inline",locationLoader.style.display="none",captureButton.style.display="inline",videoPlayer.srcObject&&videoPlayer.srcObject.getVideoTracks().forEach(function(e){e.stop()}),setTimeout(function(){createPostArea.style.transform="translateY(100vh)"},1)}function onSaveButtonClicked(e){"caches"in window&&caches.open("user-requested").then(function(e){e.add("https://httpbin.org/get"),e.add("/src/images/sf-boat.jpg")})}function clearCards(){for(;sharedMomentsArea.hasChildNodes();)sharedMomentsArea.removeChild(sharedMomentsArea.lastChild)}function createCard(e){var t=document.createElement("div"),a=(t.className="shared-moment-card mdl-card mdl-shadow--2dp",document.createElement("div")),o=(a.className="mdl-card__title",a.style.backgroundImage="url("+e.image+")",a.style.backgroundSize="cover",t.appendChild(a),document.createElement("h2")),a=(o.style.color="white",o.className="mdl-card__title-text",o.textContent=e.title,a.appendChild(o),document.createElement("div"));a.className="mdl-card__supporting-text",a.textContent=e.location,a.style.textAlign="center",t.appendChild(a),componentHandler.upgradeElement(t),sharedMomentsArea.appendChild(t)}function updateUI(e){clearCards();for(var t=0;t<e.length;t++)createCard(e[t])}function sendData(){var e=(new Date).toISOString(),t=new FormData;t.append("id",e),t.append("title",titleInput.value),t.append("location",locationInput.value),t.append("rawLocationLat",fetchedLocation.lat),t.append("rawLocationLng",fetchedLocation.lng),picture&&t.append("file",picture,e+".png"),fetch("http://localhost:3000/api/savePost",{method:"POST",body:t}).then(e=>{console.log("Send Data",e),updateUI()})}locationBtn.addEventListener("click",function(){"geolocation"in navigator&&(locationLoader.style.display="none",locationBtn.style.display="inline",navigator.geolocation.getCurrentPosition(e=>{console.log("geolocation->",e,e.coords);e=e.coords;fetchedLocation={lat:e.latitude,lng:e.longitude},locationInput.value="In Iran",document.querySelector("#manual-location").classList.add("is-focused")},e=>{console.log(e.name+": "+e.message),locationBtn.style.display="inline",locationLoader.style.display="none",alert("Couldn't fetch location, please enter manually!"),fetchedLocation={lat:0,lng:0}},{timeout:7e3}))}),captureButton.addEventListener("click",e=>{canvasElement.style.display="block",videoPlayer.style.display="none",captureButton.style.display="none",canvasElement.getContext("2d").drawImage(videoPlayer,0,0,canvas.width,videoPlayer.videoHeight/(videoPlayer.videoWidth/canvas.width)),videoPlayer.srcObject.getVideoTracks().forEach(function(e){e.stop()}),picture=dataURItoBlob(canvasElement.toDataURL())}),imagePicker.addEventListener("change",function(e){picture=e.target.files[0]}),shareImageButton.addEventListener("click",openCreatePostModal),closeCreatePostModalButton.addEventListener("click",closeCreatePostModal);var url="https://pwgram-30323-default-rtdb.asia-southeast1.firebasedatabase.app/posts.json",networkDataRecived=!1;fetch(url).then(function(e){return e.json()}).then(function(e){console.log("from web data",e),networkDataRecived=!0;var t,a=[];for(t in e)Object.hasOwnProperty.call(e,t)&&a.push(e[t]);updateUI(a)}),"indexedDB"in window&&readAllData("posts").then(e=>{networkDataRecived||updateUI(e)}),form.addEventListener("submit",function(e){e.preventDefault(),""!==titleInput.value.trim()&&""!==locationInput.value.trim()?(sendData(),closeCreatePostModal()):alert("Please Enter valid data !")});